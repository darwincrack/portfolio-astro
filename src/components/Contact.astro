---
import ContactMenu from './ContactMenu.astro';

import profileImage from '../images/profile-image.jpg';

const services = [
  "Desarrollo de páginas web a la medida",
  "Desarrollo de aplicaciones móviles",
  "Temas de WordPress",
  "Base de datos",
  "Posicionamiento SEO",
  "Asesorías"
];

const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || '6Lf22YkqAAAAAI3bpWLQB0_UYS3HWEHQ5THo1ZjC';
const CALENDLY_URL = import.meta.env.PUBLIC_CALENDLY_URL || '';
---

<section id="contact-section" class="py-5">
  <div class="container">
    <h2 class="text-center mb-5">Contáctame</h2>

    <div class="row g-4 h-100">
      <div class="col-md-6 d-flex">
        <div class="card border-0 shadow-sm w-100">
          <div class="card-body p-4 d-flex flex-column">
            <h3 class="h5 mb-4">¿Necesitas ayuda con tu proyecto?</h3>
            
            <p class="lead mb-4">
              Estoy aquí para ayudarte a hacer realidad tu visión digital. Contáctame por cualquiera de estos medios:
            </p>

            {CALENDLY_URL && (
              <a
                href={CALENDLY_URL}
                target="_blank"
                rel="noopener noreferrer"
                class="btn btn-calendly mb-4"
              >
                <i class="fas fa-calendar-check me-2"></i>
                Agendar consulta gratuita de 15 min
              </a>
            )}

            <div class="contact-methods mb-4">
              <div class="contact-method mb-3">
                <i class="fas fa-envelope gradient-text me-2"></i>
                <a href="mailto:darwinc.dev@gmail.com" class="gradient-text text-decoration-none">
                  darwinc.dev@gmail.com
                </a>
              </div>
              
              <div class="contact-method mb-3">
                <i class="fas fa-phone gradient-text me-2"></i>
                <a href="tel:+584125447114" class="gradient-text text-decoration-none">
                  +58 412 544 7114
                </a>
              </div>

              <div class="contact-method">
                
                <i class="fab fa-whatsapp gradient-text me-2"></i>
                <a href="https://wa.link/p82cmn" class="gradient-text text-decoration-none">
                  WhatsApp
                </a>
              </div>
            </div>

            <div class="availability mt-auto">
              <p class="mb-0">
                <i class="fas fa-clock gradient-text me-2"></i>
                Disponible de Lunes a Viernes, 9:00 AM - 6:00 PM (GMT-4)
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6 d-flex">
        <div class="card border-0 shadow-sm w-100">
          <div class="card-body p-4 d-flex flex-column">
            <h3 class="h4 mb-4">Envíame un mensaje</h3>
            
            <form action="https://formspree.io/f/xrbgaarw" 
                  method="POST" 
                  class="contact-form d-flex flex-column flex-grow-1"
                  accept="application/json">
              <div class="mb-3">
                <label for="name" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="name" name="nombre" autocomplete="name" required>
              </div>
              
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" autocomplete="email" required>
              </div>
              
              <div class="mb-3 flex-grow-1">
                <label for="message" class="form-label">Mensaje</label>
                <textarea class="form-control h-100" id="message" name="message" autocomplete="off" style="min-height: 150px;" required></textarea>
              </div>

              <div class="g-recaptcha flex-grow-1 mb-3  mt-4" 
                   data-sitekey={RECAPTCHA_SITE_KEY}
                   data-callback="onRecaptchaSuccess"
                   data-expired-callback="onRecaptchaExpired">
              </div>

              <button type="submit" class="btn btn-primary w-100 mt-auto" disabled>
                Enviar mensaje
                <i class="fas fa-paper-plane ms-2"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>


  <ContactMenu />
 
</section>

<style>
  /* Añade esto al inicio de tus estilos */
  #contact-section {
    scroll-margin-top: 30px; /* Ajusta este valor según necesites */
  }

  /* Estilos base */
  section {
    background-color: var(--primary-bg);
    color: var(--text);
  }

  /* Estilos para las cards */
  .card {
    background-color: var(--primary-bg) !important;
    border: 1px solid var(--secondary-bg) !important;
    color: var(--text) !important;
  }

  /* Estilos para el formulario */
  .contact-form .form-control {
    background-color: var(--secondary-bg) !important;
    border: 1px solid var(--secondary-bg);
    color: var(--text) !important;
    padding: 0.75rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
  }

  .contact-form .form-control:focus {
    border-color: var(--gradient-1);
    box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
    background-color: var(--secondary-bg) !important;
  }

  .contact-form .form-control::placeholder {
    color: var(--text-muted);
  }

  /* Ajustes específicos para modo oscuro */
  :root[data-theme="dark"] .card {
    background-color: rgba(17, 25, 40, 0.75) !important;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
  }

  :root[data-theme="dark"] .form-control {
    background-color: rgba(17, 25, 40, 0.75) !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  :root[data-theme="dark"] .form-control:focus {
    background-color: rgba(17, 25, 40, 0.9) !important;
    border-color: var(--gradient-1);
  }

  /* Estilos para títulos */
  h2.text-center {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 2rem;
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    width: 100%;
    text-align: center;
  }

  /* Animación específica para el título */
  #contact-section h2.animate-initial {
    opacity: 0;
    transform: translateY(-30px);
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }

  #contact-section h2.animate-in {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }

  /* Efecto de brillo para modo oscuro */
  :root[data-theme="dark"] h2.text-center {
    text-shadow: 0 0 20px rgba(14, 165, 233, 0.5),
                 0 0 30px rgba(14, 165, 233, 0.3);
    animation: glow 3s ease-in-out infinite;
  }

  @keyframes glow {
    0% {
      text-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
    }
    50% {
      text-shadow: 0 0 20px rgba(14, 165, 233, 0.5),
                   0 0 30px rgba(14, 165, 233, 0.3);
    }
    100% {
      text-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
    }
  }

  /* Estilos para subtítulos */
  h3.h4, h3.h5 {
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 600;
  }

  :root[data-theme="dark"] h3.h4,
  :root[data-theme="dark"] h3.h5 {
    text-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
  }

  /* Estilos para el texto gradiente */
  .gradient-text {
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .contact-form .form-label {
    color: var(--text);
  }

  .contact-form .btn-primary {
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    border: none;
    padding: 0.75rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    color: #fff;
  }

  .contact-form .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
  }

  /* Botón CTA Calendly */
  .btn-calendly {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    color: #fff !important;
    text-decoration: none;
    transition: all 0.3s ease;
    width: 100%;
  }

  .btn-calendly:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.35);
    color: #fff !important;
  }

  /* Estilos para el botón de WhatsApp */
  .whatsapp-button {
    position: fixed;
    width: 60px;
    height: 60px;
    bottom: 40px;
    right: 40px;
    background-color: #25d366;
    color: #FFF;
    border-radius: 50px;
    text-align: center;
    font-size: 30px;
    box-shadow: 2px 2px 3px #999;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .whatsapp-button:hover {
    transform: scale(1.1);
    color: #FFF;
  }

  /* Animaciones mejoradas */
  .animate-initial {
    opacity: 0;
    transform: translateY(30px);
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform, opacity;
  }

  .animate-in {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }

  /* Animación especial para el botón de WhatsApp */
  .whatsapp-button.animate-initial {
    transform: scale(0.8) translateY(30px);
  }

  .whatsapp-button.animate-in {
    transform: scale(1) translateY(0) !important;
  }

  /* Delay para la segunda card */
  .col-md-6:nth-child(2) .card.animate-initial {
    transition-delay: 0.2s;
  }

  @media (max-width: 768px) {
    .card {
      transition-delay: 0s !important;
    }
  }
</style>

<script>
  // Función para cargar el script de reCAPTCHA
  function loadRecaptchaScript() {
    if (typeof window.grecaptcha === 'undefined' && !document.querySelector('script[src*="recaptcha"]')) {
      const script = document.createElement('script');
      script.src = 'https://www.google.com/recaptcha/api.js';
      script.async = true;
      script.defer = true;
      document.body.appendChild(script);
    }
  }

  // Función para observar la sección de contacto
  function initRecaptchaObserver() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          loadRecaptchaScript();
          observer.unobserve(entry.target); // Dejar de observar una vez cargado
        }
      });
    }, {
      threshold: 0.1, // Cargar cuando al menos 10% de la sección sea visible
      rootMargin: '50px' // Cargar un poco antes de llegar a la sección
    });

    // Observar la sección de contacto
    const contactSection = document.querySelector('#contact-section');
    if (contactSection) {
      observer.observe(contactSection);
    }
  }

  // Funciones de callback para reCAPTCHA
  window.onRecaptchaSuccess = function() {
    const submitButton = document.querySelector('.contact-form button[type="submit"]');
    if (submitButton) submitButton.disabled = false;
  };

  window.onRecaptchaExpired = function() {
    const submitButton = document.querySelector('.contact-form button[type="submit"]');
    if (submitButton) submitButton.disabled = true;
  };

  function initContactForm() {
    const form = document.querySelector('.contact-form');
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Verificar reCAPTCHA
      const recaptchaResponse = grecaptcha.getResponse();
      if (!recaptchaResponse) {
        alert('Por favor, completa el reCAPTCHA');
        return;
      }

      const formElement = e.target as HTMLFormElement;
      const submitButton = formElement.querySelector('button[type="submit"]') as HTMLButtonElement;
      const formData = new FormData(formElement);
      
      try {
        // Cambiar estado del botón
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        
        // Enviar formulario
        const response = await fetch('https://formspree.io/f/xrbgaarw', {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          },
          mode: 'cors' // Agregar modo CORS
        });

        const data = await response.json();
        
        if (response.ok) {
          // Éxito
          formElement.reset();
          alert('¡Mensaje enviado con éxito! Pronto me pondré en contacto contigo.');
        } else {
          // Error con respuesta
          throw new Error(data.error || 'Error al enviar el mensaje');
        }
      } catch (error) {
        // Error general
        console.error('Error:', error);
        alert('Hubo un error al enviar el mensaje. Por favor, intenta nuevamente.');
      } finally {
        // Restaurar botón
        submitButton.disabled = false;
        submitButton.innerHTML = 'Enviar mensaje <i class="fas fa-paper-plane ms-2"></i>';
      }
    });
  }

  // Inicializar el observer en lugar de cargar reCAPTCHA directamente
  document.addEventListener('DOMContentLoaded', initRecaptchaObserver);
  document.addEventListener('astro:page-load', initRecaptchaObserver);

  function initContactAnimations() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-in');
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '50px'
    });

    // Observar las cards con delay escalonado
    document.querySelectorAll('#contact-section .card').forEach((card, index) => {
      card.style.opacity = '0';
      card.classList.add('animate-initial');
      card.style.transitionDelay = `${index * 0.2}s`;
      observer.observe(card);
    });

    // Observar el título
    const title = document.querySelector('#contact-section h2');
    if (title) {
      title.style.opacity = '0';
      title.classList.add('animate-initial');
      observer.observe(title);
    }

    // Observar el botón de WhatsApp
    const whatsappButton = document.querySelector('.whatsapp-button');
    if (whatsappButton) {
      whatsappButton.style.opacity = '0';
      whatsappButton.classList.add('animate-initial');
      observer.observe(whatsappButton);
    }
  }

  // Inicializar en ambos eventos
  document.addEventListener('DOMContentLoaded', initContactAnimations);
  document.addEventListener('astro:page-load', initContactAnimations);
</script>