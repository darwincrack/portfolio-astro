---
const testimonials = [
{
    text: "Ha sido excelente, atendió nuestro requerimiento y siempre busco solucionar no solo el problema si no los obstáculos que aparecieron en el camino, siempre muy dispuesto, incluso sin importar la hora, el atendió debidamente, gracias!",
    name: "Revista Potos",
    location: "México",
    rating: 5,
    position: "abrevius.com"

  },
  {
    text: "Darwin es un excelente profesional, muy responsable y comprometido con su trabajo. Entregó el proyecto antes de tiempo y con excelente calidad. Recomendado 100%.",
    name: "Milton Orellana",
    location: "Colombia",
    rating: 5
  },
  {
    text: "Excelente trabajo, muy profesional y dedicado. Cumplió con todos los requerimientos y tiempos establecidos. Lo recomiendo ampliamente.",
    name: "Joel Araujo",
    location: "Venezuela",
    rating: 5
  },
  {
    text: "Gran profesional, muy atento y dedicado. Entregó el trabajo antes de tiempo y con excelente calidad. Muy recomendado.",
    name: "Carlos Rodriguez",
    location: "México",
    rating: 5
  },
  {
    text: "Excelente trabajo, muy profesional, altamente recomendable, eficaz y gran comunicación en el proyecto, cumpliendo tiempo y forma y Excelente precio, lo recomiendo sin duda/",
    name: "Revista Potos",
    location: "México",
    rating: 5,
    position: "Revista Potos"
  },

  

];
---

<section id="testimonials-section" class="py-5">
  <div class="container">
    <h2 class="text-center mb-5">Testimonios</h2>

    <!-- Widget de Trustpilot -->
    <div class="trustpilot-container mb-5">
        <div class="trustpilot-widget" data-locale="es-ES" data-template-id="5419b6a8b0d04a076446a9ad" data-businessunit-id="643d86b541a0d9256c416d2a" data-style-height="24px" data-style-width="100%" data-theme="light" data-min-review-count="0" data-without-reviews-preferred-string-id="1" data-style-alignment="center">
            <a href="https://es.trustpilot.com/review/darwincedeno.com" target="_blank" rel="noopener">Trustpilot</a>
          </div>
    </div>

    <!-- Testimonios Slider -->
    <div class="testimonials-slider-container">
      <button class="slider-arrow prev" id="testimonials-prev" aria-label="Previous testimonial">
        <i class="fas fa-chevron-left"></i>
      </button>
      
      <div class="testimonials-slider" id="testimonials-slider">
        {testimonials.map((testimonial, index) => (
          <div class="testimonial-card" data-index={index}>
            <div class="testimonial-content">
              <div class="rating mb-3">
                {[...Array(testimonial.rating)].map(() => (
                  <i class="fas fa-star"></i>
                ))}
              </div>
              <p class="testimonial-text">{testimonial.text}</p>
            </div>
            <div class="testimonial-author">
              <h4 class="h6 mb-1">{testimonial.name}</h4>
              <p class="location mb-1">{testimonial.location}</p>
              <p class="position">{testimonial.position}</p>
            </div>
          </div>
        ))}
      </div>

      <button class="slider-arrow next" id="testimonials-next" aria-label="Next testimonial">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</section>

<style>
  h2.text-center {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 2rem;
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    display: inline-block;
    left: 50%;
    transform: translateX(-50%);
  }

  .testimonial-card {
    background-color: var(--primary-bg);
    border: 1px solid var(--secondary-bg);
    border-radius: 1rem;
    padding: 2rem;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.3s ease;
    position: relative;
    min-width: calc((100% - 3rem) / 3);
  }

  .testimonial-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .rating {
    color: var(--gradient-1);
    margin-bottom: 1rem;
  }

  .testimonial-text {
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--text);
    margin-bottom: auto;
    flex: 1;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 6;
    -webkit-box-orient: vertical;
  }

  .testimonial-author {
    border-top: 1px solid var(--secondary-bg);
    padding-top: 1rem;
    margin-top: 1rem;
  }

  .testimonial-author h4 {
    color: var(--text);
    font-weight: 600;
  }

  .location {
    font-size: 0.85rem;
    color: var(--text);
    opacity: 0.8;
  }

  .position {
    font-size: 0.85rem;
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .btn-outline-primary {
    color: var(--gradient-1);
    border: 2px solid var(--gradient-1);
    padding: 0.5rem 2rem;
    border-radius: 2rem;
    transition: all 0.3s ease;
  }

  .btn-outline-primary:hover {
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    border-color: transparent;
    color: white;
    transform: translateY(-2px);
  }

  /* Ajustes para modo oscuro */
  :root[data-theme="dark"] .testimonial-card {
    background-color: rgba(17, 25, 40, 0.75);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  :root[data-theme="dark"] .testimonial-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .trustpilot-container {
    max-width: 800px;
    margin: 0 auto 3rem;
    padding: 1rem;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* Ajuste para modo oscuro */
  :root[data-theme="dark"] .trustpilot-container {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(4px);
  }

  .testimonials-slider-container {
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
    overflow: hidden;
    padding: 0 2rem;
  }

  .testimonials-slider {
    display: flex;
    transition: transform 0.5s ease;
    gap: 1.5rem;
  }

  .testimonial-card {
    min-width: calc((100% - 3rem) / 3);
    opacity: 1;
    transform: scale(1);
    transition: all 0.5s ease;
  }

  .slider-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2));
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 2;
    transition: all 0.3s ease;
  }

  .slider-arrow:hover {
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .slider-arrow.prev {
    left: 0;
  }

  .slider-arrow.next {
    right: 0;
  }

  @media (max-width: 992px) {
    .testimonial-card {
      min-width: calc((100% - 1.5rem) / 2);
    }
  }

  @media (max-width: 768px) {
    .testimonial-card {
      min-width: 100%;
    }
  }

  /* Animaciones */
  .testimonial-card.animate-initial {
    opacity: 0;
    transform: translateY(30px);
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform, opacity;
  }

  .testimonial-card.animate-in {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }
</style>

<script>

function loadTrustpilotWidget() {
    const existingScript = document.getElementById('trustpilot-widget-script');
    if (!existingScript) {
      const script = document.createElement('script');
      script.id = 'trustpilot-widget-script';
      script.src = 'https://widget.trustpilot.com/bootstrap/v5/tp.widget.bootstrap.min.js';
      script.async = true;
      document.head.appendChild(script);
    }
  }

  // Cargar el widget cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', loadTrustpilotWidget);
  
  // Recargar el widget cuando Astro complete la navegación
  document.addEventListener('astro:page-load', loadTrustpilotWidget);

  function initTestimonialsSlider() {
    const slider = document.querySelector('#testimonials-slider');
    const cards = document.querySelectorAll('#testimonials-slider .testimonial-card');
    const prevBtn = document.querySelector('#testimonials-prev');
    const nextBtn = document.querySelector('#testimonials-next');
    let currentIndex = 0;
    let autoplayInterval;

    // Si no encontramos los elementos, salimos de la función
    if (!slider || !cards.length || !prevBtn || !nextBtn) {
      console.log('No se encontraron elementos del slider de testimonios');
      return;
    }

    function updateSlider() {
      const cardWidth = cards[0].offsetWidth;
      const gap = 24;
      const offset = currentIndex * -(cardWidth + gap);
      slider.style.transform = `translateX(${offset}px)`;
    }

    function nextSlide() {
      const totalSlides = cards.length;
      const visibleSlides = window.innerWidth > 992 ? 3 : window.innerWidth > 768 ? 2 : 1;
      const maxIndex = totalSlides - visibleSlides;
      
      if (currentIndex >= maxIndex) {
        currentIndex = 0;
      } else {
        currentIndex++;
      }
      updateSlider();
    }

    function prevSlide() {
      const totalSlides = cards.length;
      const visibleSlides = window.innerWidth > 992 ? 3 : window.innerWidth > 768 ? 2 : 1;
      const maxIndex = totalSlides - visibleSlides;
      
      if (currentIndex <= 0) {
        currentIndex = maxIndex;
      } else {
        currentIndex--;
      }
      updateSlider();
    }

    function startAutoplay() {
      stopAutoplay();
      autoplayInterval = setInterval(nextSlide, 5000);
    }

    function stopAutoplay() {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
      }
    }

    // Event Listeners con verificación null
    prevBtn.addEventListener('click', () => {
      prevSlide();
      startAutoplay();
    });

    nextBtn.addEventListener('click', () => {
      nextSlide();
      startAutoplay();
    });

    // Manejar cambios de tamaño de ventana
    window.addEventListener('resize', updateSlider);

    // Iniciar autoplay
    startAutoplay();

    // Pausar autoplay al hover
    slider.addEventListener('mouseenter', stopAutoplay);
    slider.addEventListener('mouseleave', startAutoplay);

    // Primera actualización
    updateSlider();
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', initTestimonialsSlider);
  // Reinicializar cuando Astro complete la navegación
  document.addEventListener('astro:page-load', initTestimonialsSlider);

  function initTestimonialAnimations() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-in');
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '50px'
    });

    document.querySelectorAll('#testimonials-section .testimonial-card').forEach((card, index) => {
      card.style.opacity = '0';
      card.classList.add('animate-initial');
      card.style.transitionDelay = `${index * 0.2}s`;
      observer.observe(card);
    });
  }

  document.addEventListener('DOMContentLoaded', initTestimonialAnimations);
  document.addEventListener('astro:page-load', initTestimonialAnimations);
</script>