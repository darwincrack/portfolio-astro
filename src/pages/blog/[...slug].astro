---
export const prerender = true;
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: post,
  }));
}

const post: CollectionEntry<'blog'> = Astro.props;
const { Content } = await post.render();

// Art칤culos relacionados: mismos tags primero, luego rellenar con los m치s recientes (m치x. 8 para grid 2x4)
const allPosts = await getCollection('blog');
const currentTags = post.data.tags ?? [];
const relatedPosts = allPosts
  .filter((p) => p.slug !== post.slug)
  .map((p) => ({
    post: p,
    score: (p.data.tags ?? []).filter((t) => currentTags.includes(t)).length,
  }))
  .sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return b.post.data.pubDate.valueOf() - a.post.data.pubDate.valueOf();
  })
  .slice(0, 8)
  .map(({ post: p }) => p);

// Construir URL del post
const siteUrl = 'https://darwincd.com';
const postUrl = `${siteUrl}/blog/${post.slug}/`;
const postImage = post.data.image?.url || `${siteUrl}/logodc.jpg`;

// Schema Article para el post
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.data.title,
  "description": post.data.description,
  "image": postImage,
  "datePublished": post.data.pubDate.toISOString(),
  "dateModified": post.data.updatedDate ? new Date(post.data.updatedDate).toISOString() : post.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": post.data.author || "Darwin Cede침o",
    "url": siteUrl
  },
  "publisher": {
    "@type": "Person",
    "name": "Darwin Cede침o",
    "url": siteUrl
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": postUrl
  },
  "url": postUrl
};

// Breadcrumb Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Inicio",
      "item": siteUrl
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": `${siteUrl}/blog/`
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": post.data.title,
      "item": postUrl
    }
  ]
};
---
<Layout 
  title={post.data.title} 
  description={post.data.description}
  image={postImage}
  type="article"
  publishedTime={post.data.pubDate.toISOString()}
  modifiedTime={post.data.updatedDate ? new Date(post.data.updatedDate).toISOString() : post.data.pubDate.toISOString()}
  author={post.data.author || "Darwin Cede침o"}
  section="Tecnolog칤a"
>
    {/* Schema Article */}
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
    
    {/* Schema Breadcrumb */}
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
    
    <main class="blog-page-container">
        <div class="container">
        <nav aria-label="Breadcrumb" style="margin-bottom: 1rem;">
            <ol style="display: flex; list-style: none; padding: 0; gap: 0.5rem; font-size: 0.9rem; opacity: 0.8;">
                <li><a href="/" style="color: inherit; text-decoration: none;">Inicio</a></li>
                <li>/</li>
                <li><a href="/blog/" style="color: inherit; text-decoration: none;">Blog</a></li>
                <li>/</li>
                <li>{post.data.title}</li>
            </ol>
        </nav>
        
        <article itemscope itemtype="https://schema.org/Article">
            {post.data.image && (
                <img 
                    src={post.data.image.url} 
                    alt={post.data.image.alt} 
                    width={720} 
                    height={360} 
                    class="main-image"
                    loading="eager"
                    decoding="sync"
                    itemprop="image"
                />
            )}
            <h1 itemprop="headline">{post.data.title}</h1>
            <p><em>Publicado el <time datetime={post.data.pubDate.toISOString()} itemprop="datePublished">
                {post.data.pubDate.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
            </time></em></p>
            {post.data.updatedDate && (
                <p><em>Actualizado el <time datetime={new Date(post.data.updatedDate).toISOString()} itemprop="dateModified">
                    {new Date(post.data.updatedDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
                </time></em></p>
            )}
            <div class="content" itemprop="articleBody">
                <Content />
            </div>
        </article>
        </div>

        {relatedPosts.length > 0 && (
            <section class="related-notes" aria-label="Notas relacionadas">
                <div class="related-notes-wrap">
                <h2 class="related-notes-title">Notas relacionadas</h2>
                <div class="related-notes-grid">
                    {relatedPosts.map((related) => (
                        <a href={`/blog/${related.slug}/`} class="related-card-link">
                            <article class="related-card">
                                {related.data.image ? (
                                    <img
                                        src={related.data.image.url}
                                        alt={related.data.image.alt}
                                        width={400}
                                        height={200}
                                        class="related-card-img"
                                        loading="lazy"
                                        decoding="async"
                                    />
                                ) : (
                                    <div class="related-card-img no-image">游닇</div>
                                )}
                                <div class="related-card-body">
                                    <h3 class="related-card-title">{related.data.title}</h3>
                                    <p class="related-card-description">{related.data.description.length > 80 ? related.data.description.slice(0, 80) + '...' : related.data.description}</p>
                                    <time class="related-card-date" datetime={related.data.pubDate.toISOString()}>
                                        {related.data.pubDate.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' })}
                                    </time>
                                </div>
                            </article>
                        </a>
                    ))}
                </div>
                </div>
            </section>
        )}
    </main>
     <style>
        .blog-page-container {
            padding-top: 90px !important;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 2rem;
        }
        .main-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .content {
            line-height: 1.7;
        }

        /* Notas relacionadas: grid 2 filas x 4 columnas */
        .related-notes {
            margin-top: 4rem;
            padding-top: 2rem;
            padding-bottom: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .related-notes-wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        .related-notes-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text);
        }
        .related-notes-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, auto);
            gap: 1.25rem;
        }
        @media (max-width: 900px) {
            .related-notes-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(4, auto);
            }
        }
        @media (max-width: 500px) {
            .related-notes-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(8, auto);
            }
        }
        .related-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
            height: 100%;
        }
        .related-card {
            background: var(--secondary-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .related-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .related-card-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }
        .related-card-img.no-image {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        .related-card-body {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .related-card-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0 0 0.35rem 0;
            color: var(--text);
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .related-card-description {
            font-size: 0.8rem;
            opacity: 0.85;
            margin: 0;
            flex-grow: 1;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .related-card-date {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 0.5rem;
        }
     </style>
</Layout> 